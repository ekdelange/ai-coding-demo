<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Actuator Tariff Impact Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/tabulator-tables@5.6.2/dist/css/tabulator.min.css" />
  <style>
    :root {
      --brand: #e9a16f;
      --sidebar: #f5c6a5;
      --panel: #fff7f1;
      --text: #333;
      --muted: #666;
      --success: #2a9d8f;
      --warning: #f4a261;
      --danger: #e76f51;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: #faf4ef;
      color: var(--text);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      background: linear-gradient(90deg, var(--brand), #f7c19b);
      color: #fff;
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }

    header h1 {
      margin: 0;
      font-size: 1.4rem;
      letter-spacing: 0.02em;
    }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .toolbar button,
    .toolbar label {
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 0.45rem 0.75rem;
      border-radius: 6px;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .toolbar button:hover,
    .toolbar label:hover {
      background: rgba(255, 255, 255, 0.35);
    }

    .toolbar input[type="file"] {
      display: none;
    }

    main {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(260px, 320px) minmax(0, 1fr) minmax(220px, 280px);
      gap: 1rem;
      padding: 1rem;
    }

    @media (max-width: 1100px) {
      main {
        grid-template-columns: minmax(260px, 320px) minmax(0, 1fr);
        grid-template-rows: auto auto;
      }
      .insights-panel {
        grid-column: 1 / -1;
        order: 3;
      }
    }

    @media (max-width: 840px) {
      main {
        grid-template-columns: 1fr;
      }
      .sidebar,
      .content,
      .insights-panel {
        order: initial;
      }
    }

    .sidebar,
    .insights-panel {
      background: var(--sidebar);
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .content {
      background: var(--panel);
      border-radius: 12px;
      padding: 1rem 1.25rem;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .section-title {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
      margin-bottom: 0.25rem;
    }

    .filter-group {
      background: rgba(255, 255, 255, 0.6);
      border-radius: 10px;
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .filter-group label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .filter-group input[type="radio"],
    .filter-group input[type="checkbox"] {
      accent-color: var(--brand);
    }

    .tariff-slider {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.35rem 0.75rem;
      align-items: center;
      padding: 0.35rem 0.45rem;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.8);
      font-size: 0.82rem;
    }

    .tariff-slider input[type="range"] {
      grid-column: 1 / -1;
      width: 100%;
      accent-color: var(--brand);
    }

    .tariff-slider span {
      font-weight: 600;
    }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 10px;
      padding: 0.75rem 1rem;
    }

    .top-bar select {
      padding: 0.4rem 0.5rem;
      border-radius: 6px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      min-width: 200px;
    }

    .kpi-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.75rem;
    }

    .kpi-card {
      background: #fff;
      border-radius: 12px;
      padding: 0.9rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.05);
    }

    .kpi-card h3 {
      margin: 0;
      font-size: 0.85rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .kpi-card .value {
      font-size: 1.35rem;
      font-weight: 700;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    #costChart,
    #mapChart,
    #whatIfChart {
      width: 100%;
      min-height: 280px;
    }

    .tab-header {
      display: flex;
      gap: 0.5rem;
    }

    .tab-header button {
      background: rgba(0, 0, 0, 0.05);
      border: none;
      padding: 0.5rem 0.85rem;
      border-radius: 999px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .tab-header button.active {
      background: var(--brand);
      color: #fff;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .legend {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .legend span {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .legend i {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 999px;
    }

    .warning {
      background: #fff0e5;
      color: var(--danger);
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      font-size: 0.85rem;
      border: 1px solid rgba(231, 111, 81, 0.3);
    }

    .insights-panel h2 {
      margin: 0;
      font-size: 1.1rem;
    }

    .insights-panel p {
      margin: 0;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .insights-panel ul {
      margin: 0;
      padding-left: 1rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>Actuator Tariff Impact Dashboard</h1>
    <div class="toolbar">
      <label>
        <span>Upload Workbook (.xlsx)</span>
        <input id="fileInput" type="file" accept=".xlsx,.csv,.json,.zip,.gz" />
      </label>
      <button id="jsonPasteBtn" type="button">Paste JSON</button>
      <button id="resetOverridesBtn" type="button">Reset Overrides</button>
      <button id="downloadCsvBtn" type="button">Download CSV (filtered)</button>
      <button id="downloadXlsxBtn" type="button">Download XLSX (filtered)</button>
    </div>
  </header>

  <main>
    <aside class="sidebar">
      <div>
        <div class="section-title">Scenario Date</div>
        <div id="scenarioContainer" class="filter-group"></div>
      </div>
      <div>
        <div class="section-title">Final Assembly Site</div>
        <div id="assemblyContainer" class="filter-group"></div>
      </div>
      <div>
        <div class="section-title">Logistics</div>
        <div class="filter-group">
          <label><input id="includeFixed" type="checkbox" /> Include fixed logistics fees (per 10k units)</label>
        </div>
      </div>
      <div>
        <div class="section-title">Tariff Overrides</div>
        <div id="tariffOverrides" class="filter-group" style="max-height: 300px; overflow:auto;"></div>
      </div>
      <div>
        <div class="section-title">What-if Routing</div>
        <div class="filter-group">
          <label for="motorRouting">Motor origin override</label>
          <select id="motorRouting" style="padding:0.4rem; border-radius:6px; border:1px solid rgba(0,0,0,0.1);">
            <option value="default">Use workbook data</option>
            <option value="Switzerland">China → Switzerland</option>
            <option value="United States">China → United States</option>
            <option value="Mexico">China → Mexico</option>
          </select>
        </div>
      </div>
      <div id="warnings"></div>
    </aside>

    <section class="content">
      <div class="top-bar">
        <div>
          <label for="skuSelect" style="font-size:0.85rem; color:var(--muted);">Select SKU</label>
          <select id="skuSelect"></select>
        </div>
        <div id="rowCounter" style="font-size:0.85rem; color:var(--muted);"></div>
      </div>

      <div class="kpi-row" id="kpiRow"></div>

      <div class="card">
        <div class="section-title">Cost Composition by Assembly Site</div>
        <div id="costChart"></div>
        <div class="legend" id="legend"></div>
      </div>

      <div class="card">
        <div class="section-title">SKU Cost Breakdown</div>
        <div id="table"></div>
      </div>

      <div class="card">
        <div class="tab-header">
          <button class="tab-btn active" data-tab="map">Map</button>
          <button class="tab-btn" data-tab="whatif">What-if</button>
        </div>
        <div id="tab-map" class="tab-content active">
          <div id="mapChart"></div>
        </div>
        <div id="tab-whatif" class="tab-content">
          <div id="whatIfChart"></div>
        </div>
      </div>
    </section>

    <aside class="insights-panel">
      <h2>Insights</h2>
      <p id="insightsText">Upload the workbook to begin.</p>
      <div>
        <div class="section-title">FX Reference (display only)</div>
        <ul id="fxList"></ul>
      </div>
    </aside>
  </main>

  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/tabulator-tables@5.6.2/dist/js/tabulator.min.js"></script>
  <script>
    const REQUIRED_SHEETS = ['Products','BOM','Components','Sites','AssemblyOptions','LogisticsLanes','TariffScenarios','Tariffs_US','TariffInputs','MapNodes','FX'];

    const COLORS = {
      'BU_CH_MUR': '#e76f51',
      'PLANT_US_MI': '#2a9d8f',
      'PLANT_MX_NL': '#264653'
    };

    const state = {
      rawSheets: {},
      products: [],
      bom: [],
      components: [],
      sites: [],
      assemblyOptions: [],
      logisticsLanes: [],
      tariffScenarios: [],
      tariffs: [],
      tariffInputs: [],
      mapNodes: [],
      fx: [],
      warnings: [],
      filters: {
        scenarioDate: null,
        assemblySite: null,
        includeFixed: false,
        sku: null
      },
      tariffOverrides: new Map(),
      whatIf: {
        motorRouting: 'default'
      },
      results: [],
      summaryBySku: new Map(),
      tableInstance: null
    };

    document.addEventListener('DOMContentLoaded', () => {
      bindUI();
    });

    function bindUI() {
      document.getElementById('fileInput').addEventListener('change', handleFileInput);
      document.getElementById('jsonPasteBtn').addEventListener('click', handleJsonPaste);
      document.getElementById('resetOverridesBtn').addEventListener('click', resetOverrides);
      document.getElementById('includeFixed').addEventListener('change', (e) => {
        state.filters.includeFixed = e.target.checked;
        recompute();
      });
      document.getElementById('motorRouting').addEventListener('change', (e) => {
        state.whatIf.motorRouting = e.target.value;
        recompute();
      });
      document.getElementById('skuSelect').addEventListener('change', (e) => {
        state.filters.sku = e.target.value || null;
        renderAll();
      });
      document.getElementById('downloadCsvBtn').addEventListener('click', () => {
        if (state.tableInstance) {
          state.tableInstance.download('csv', 'tariff_dashboard.csv');
        }
      });
      document.getElementById('downloadXlsxBtn').addEventListener('click', () => {
        if (state.tableInstance) {
          state.tableInstance.download('xlsx', 'tariff_dashboard.xlsx', {sheetName: 'TariffImpact'});
        }
      });
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
        });
      });
    }

    async function handleFileInput(event) {
      const file = event.target.files[0];
      if (!file) return;
      try {
        if (file.name.toLowerCase().endsWith('.xlsx')) {
          const data = await loadWorkbook(file);
          applyData(data);
        } else if (file.name.toLowerCase().endsWith('.json')) {
          const text = await file.text();
          const payload = JSON.parse(text);
          const data = normaliseJsonPayload(payload);
          applyData(data);
        } else if (file.name.toLowerCase().endsWith('.csv')) {
          const text = await file.text();
          const parsed = Papa.parse(text, {header: true, dynamicTyping: true});
          applyData({Products: parsed.data});
        } else if (file.name.toLowerCase().endsWith('.zip') || file.name.toLowerCase().endsWith('.gz')) {
          const data = await loadZippedCSVs(file);
          applyData(data);
        } else {
          pushWarning('Unsupported file type. Upload .xlsx, .json, .csv, .zip or .gz.');
        }
      } catch (error) {
        console.error(error);
        pushWarning(`Failed to load file: ${error.message}`);
      } finally {
        event.target.value = '';
      }
    }

    async function loadWorkbook(file) {
      const arrayBuffer = await file.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, {type: 'array'});
      const sheets = {};
      REQUIRED_SHEETS.forEach((name) => {
        if (workbook.SheetNames.includes(name)) {
          sheets[name] = XLSX.utils.sheet_to_json(workbook.Sheets[name], {defval: null});
        }
      });
      return sheets;
    }

    async function loadZippedCSVs(file) {
      if (!('DecompressionStream' in window)) {
        throw new Error('Zip support requires a modern browser with DecompressionStream.');
      }
      const lower = file.name.toLowerCase();
      const type = lower.endsWith('.gz') ? 'gzip' : 'deflate';
      const stream = file.stream().pipeThrough(new DecompressionStream(type));
      const text = await new Response(stream).text();
      const parsed = Papa.parse(text, {header: true, dynamicTyping: true});
      if (!parsed.data || !parsed.data.length) {
        throw new Error('No rows detected inside the compressed file.');
      }
      if (!parsed.meta.fields.includes('sheet')) {
        throw new Error('Compressed CSV must include a "sheet" column indicating the worksheet name.');
      }
      const grouped = {};
      parsed.data.forEach(row => {
        if (!row || !row.sheet) return;
        const sheetName = row.sheet;
        const cleanRow = {...row};
        delete cleanRow.sheet;
        (grouped[sheetName] = grouped[sheetName] || []).push(cleanRow);
      });
      return grouped;
    }

    function handleJsonPaste() {
      const input = prompt('Paste JSON with sheet names as keys (e.g. {"Products": [...]} )');
      if (!input) return;
      try {
        const payload = JSON.parse(input);
        const data = normaliseJsonPayload(payload);
        applyData(data);
      } catch (error) {
        pushWarning(`Invalid JSON: ${error.message}`);
      }
    }

    function normaliseJsonPayload(payload) {
      if (Array.isArray(payload)) {
        const out = {};
        payload.forEach(entry => {
          if (entry.sheet && Array.isArray(entry.rows)) {
            out[entry.sheet] = entry.rows;
          }
        });
        return out;
      }
      return payload;
    }

    function applyData(sheets) {
      state.warnings = [];
      state.rawSheets = sheets;
      REQUIRED_SHEETS.forEach((name) => {
        if (!sheets[name]) {
          pushWarning(`${name} sheet missing. Some calculations may be incomplete.`);
          sheets[name] = [];
        }
      });
      state.products = toNumberFields(sheets.Products, ['UnitWeight_kg','AnnualDemand_US','ListPrice_CHF']);
      state.bom = toNumberFields(sheets.BOM, ['Qty']);
      state.components = toNumberFields(sheets.Components, ['UnitWeight_kg','BasePrice_CHF']);
      state.sites = toNumberFields(sheets.Sites, ['Lat','Lon']);
      state.assemblyOptions = toNumberFields(sheets.AssemblyOptions, ['BaseConvCost_CHF','ScrapRate','Yield']);
      state.logisticsLanes = toNumberFields(sheets.LogisticsLanes, ['Cost_per_kg_CHF','Fixed_per_shipment_CHF','LeadTime_days']);
      state.tariffScenarios = sheets.TariffScenarios || [];
      state.tariffs = toNumberFields(sheets.Tariffs_US, ['US_AdValoremTariff_pct']);
      state.tariffInputs = toNumberFields(sheets.TariffInputs, ['DefaultRate_pct','UserRate_pct']);
      state.mapNodes = toNumberFields(sheets.MapNodes, ['Lat','Lon']);
      state.fx = sheets.FX || [];
      initialiseFilters();
      recompute();
    }

    function toNumberFields(rows, numericFields) {
      if (!Array.isArray(rows)) return [];
      return rows.map(row => {
        const copy = {...row};
        numericFields.forEach(field => {
          if (copy[field] !== null && copy[field] !== undefined && copy[field] !== '') {
            copy[field] = Number(copy[field]);
          }
        });
        return copy;
      });
    }

    function initialiseFilters() {
      const scenarioContainer = document.getElementById('scenarioContainer');
      scenarioContainer.innerHTML = '';
      state.tariffScenarios.forEach((scenario, index) => {
        const id = `scenario-${index}`;
        const wrapper = document.createElement('label');
        wrapper.innerHTML = `<input type="radio" name="scenario" id="${id}" value="${scenario.ScenarioDate}"> ${scenario.ScenarioDate}`;
        scenarioContainer.appendChild(wrapper);
      });
      if (state.tariffScenarios.length) {
        state.filters.scenarioDate = state.tariffScenarios[0].ScenarioDate;
        const firstInput = scenarioContainer.querySelector('input');
        if (firstInput) firstInput.checked = true;
      }
      scenarioContainer.querySelectorAll('input').forEach(input => {
        input.addEventListener('change', (e) => {
          state.filters.scenarioDate = e.target.value;
          recompute();
        });
      });

      const assemblyContainer = document.getElementById('assemblyContainer');
      assemblyContainer.innerHTML = '';
      const assemblySites = ['BU_CH_MUR','PLANT_US_MI','PLANT_MX_NL'];
      assemblySites.forEach((site, index) => {
        const id = `assembly-${index}`;
        const label = document.createElement('label');
        label.innerHTML = `<input type="radio" name="assembly" id="${id}" value="${site}"> ${site}`;
        assemblyContainer.appendChild(label);
      });
      state.filters.assemblySite = assemblySites[0];
      const firstAssembly = assemblyContainer.querySelector('input');
      if (firstAssembly) firstAssembly.checked = true;
      assemblyContainer.querySelectorAll('input').forEach(input => {
        input.addEventListener('change', (e) => {
          state.filters.assemblySite = e.target.value;
          renderAll();
        });
      });

      renderTariffOverrideControls();
      renderFxList();
    }

    function renderTariffOverrideControls() {
      const container = document.getElementById('tariffOverrides');
      container.innerHTML = '';
      if (!state.tariffInputs.length) {
        container.innerHTML = '<div class="warning">TariffInputs sheet missing.</div>';
        return;
      }
      state.tariffInputs.forEach((row, index) => {
        const key = `${row.ComponentClass}|${row.OriginCountry}`;
        const current = state.tariffOverrides.has(key)
          ? state.tariffOverrides.get(key)
          : (row.UserRate_pct ?? row.DefaultRate_pct ?? 0);
        const slider = document.createElement('div');
        slider.className = 'tariff-slider';
        slider.innerHTML = `
          <div>${row.ComponentClass || 'Class'} → ${row.OriginCountry || 'N/A'}</div>
          <span id="tariff-value-${index}">${current.toFixed(1)}%</span>
          <input type="range" min="0" max="50" step="0.1" value="${current}" data-key="${key}" data-index="${index}" />
        `;
        container.appendChild(slider);
      });
      container.querySelectorAll('input[type="range"]').forEach(input => {
        input.addEventListener('input', (e) => {
          const key = e.target.dataset.key;
          const index = e.target.dataset.index;
          const value = Number(e.target.value);
          state.tariffOverrides.set(key, value);
          const label = document.getElementById(`tariff-value-${index}`);
          if (label) label.textContent = `${value.toFixed(1)}%`;
          recompute();
        });
      });
    }

    function resetOverrides() {
      state.tariffOverrides.clear();
      renderTariffOverrideControls();
      recompute();
    }

    function pushWarning(message) {
      state.warnings.push(message);
      const container = document.getElementById('warnings');
      container.innerHTML = state.warnings.map(msg => `<div class="warning">${msg}</div>`).join('');
    }

    function recompute() {
      if (!state.products.length) {
        renderAll();
        return;
      }
      const componentsById = Object.fromEntries(state.components.map(c => [c.PartID, c]));
      const sitesById = Object.fromEntries(state.sites.map(s => [s.SiteID, s]));
      const bomBySku = state.bom.reduce((acc, row) => {
        if (!row.ParentSKU) return acc;
        (acc[row.ParentSKU] = acc[row.ParentSKU] || []).push(row);
        return acc;
      }, {});
      const assemblyBySku = state.assemblyOptions.reduce((acc, row) => {
        if (!row.SKU) return acc;
        (acc[row.SKU] = acc[row.SKU] || []).push(row);
        return acc;
      }, {});
      const laneMap = buildLaneMap(state.logisticsLanes);
      const scenarioTariffs = buildScenarioTariffs(state.tariffs, state.filters.scenarioDate);

      const results = [];
      const summaryBySku = new Map();

      state.products.forEach(product => {
        const sku = product.SKU;
        const options = assemblyBySku[sku] || [];
        const bomRows = bomBySku[sku] || [];
        options.forEach(option => {
          const assemblySite = sitesById[option.AssemblySiteID];
          if (!assemblySite) return;
          const yieldFactor = option.Yield && option.Yield !== 0 ? option.Yield : 1;
          let materialCost = 0;
          let logisticsComponents = 0;
          let tariffComponents = 0;
          let componentLead = 0;
          const componentDetails = [];

          bomRows.forEach(item => {
            const component = componentsById[item.PartID];
            if (!component) return;
            const qtyPer = Number(item.Qty) || 0;
            const effectiveQty = qtyPer / yieldFactor;
            const basePrice = Number(component.BasePrice_CHF) || 0;
            const weight = (Number(component.UnitWeight_kg) || 0) * effectiveQty;

            let originSite = component.OriginSiteID ? sitesById[component.OriginSiteID] : null;
            let originCountry = originSite ? originSite.Country : (component.OriginCountry || null);
            if (!originCountry && component.Class === 'Motor') {
              originCountry = 'China';
            }
            if (state.whatIf.motorRouting !== 'default' && component.Class && component.Class.toLowerCase().includes('motor')) {
              originCountry = state.whatIf.motorRouting;
            }

            materialCost += basePrice * effectiveQty;
            const laneKey = `${originCountry}|${assemblySite.Country}`;
            const lane = laneMap.get(laneKey);
            const laneCost = lane ? (lane.Cost_per_kg_CHF || 0) : 0;
            const laneFixed = lane ? (lane.Fixed_per_shipment_CHF || 0) : 0;
            const laneLead = lane ? (lane.LeadTime_days || 0) : 0;
            logisticsComponents += laneCost * weight;
            if (state.filters.includeFixed && laneFixed) {
              logisticsComponents += laneFixed / 10000;
            }
            componentLead += laneLead;

            const tariffRate = resolveTariffRate(component.Class, originCountry, scenarioTariffs);
            const tariffValue = (tariffRate / 100) * (basePrice * effectiveQty);
            tariffComponents += tariffValue;

            componentDetails.push({
              component,
              originCountry,
              tariffRate,
              lane,
              weight,
              cost: basePrice * effectiveQty,
              logistics: laneCost * weight
            });
          });

          const conversionCost = Number(option.BaseConvCost_CHF) || 0;
          let finalLogistics = 0;
          let finalTariff = 0;
          let finalLead = 0;
          const productWeight = Number(product.UnitWeight_kg) || 0;
          if (assemblySite.Country && assemblySite.Country !== 'United States') {
            const finalLaneKey = `${assemblySite.Country}|United States`;
            const finalLane = laneMap.get(finalLaneKey);
            if (finalLane) {
              finalLogistics += (finalLane.Cost_per_kg_CHF || 0) * productWeight;
              if (state.filters.includeFixed && finalLane.Fixed_per_shipment_CHF) {
                finalLogistics += finalLane.Fixed_per_shipment_CHF / 10000;
              }
              finalLead += finalLane.LeadTime_days || 0;
            }
            const finalTariffRate = resolveTariffRate('FinalAssembly', assemblySite.Country, scenarioTariffs);
            const customsValue = materialCost + conversionCost;
            finalTariff = (finalTariffRate / 100) * customsValue;
          }

          const logisticsTotal = logisticsComponents + finalLogistics;
          const tariffTotal = tariffComponents + finalTariff;
          const landedCost = materialCost + logisticsTotal + tariffTotal + conversionCost;
          const listPrice = Number(product.ListPrice_CHF) || 0;
          const margin = listPrice - landedCost;
          const marginPct = listPrice ? (margin / listPrice) * 100 : 0;
          const leadTime = componentLead + finalLead;

          const record = {
            SKU: sku,
            Description: product.Description,
            AssemblySiteID: option.AssemblySiteID,
            AssemblyCountry: assemblySite.Country,
            Material_CHF: materialCost,
            Logistics_CHF: logisticsTotal,
            Tariffs_CHF: tariffTotal,
            Conversion_CHF: conversionCost,
            LandedCost_CHF: landedCost,
            ListPrice_CHF: listPrice,
            Margin_CHF: margin,
            MarginPct: marginPct,
            LeadTime_days: leadTime,
            ComponentDetails: componentDetails,
            FinalTariffRate: assemblySite.Country !== 'United States' ? resolveTariffRate('FinalAssembly', assemblySite.Country, scenarioTariffs) : 0
          };
          results.push(record);
          if (!summaryBySku.has(sku)) summaryBySku.set(sku, []);
          summaryBySku.get(sku).push(record);
        });
      });

      state.results = results;
      state.summaryBySku = summaryBySku;
      if (!state.filters.sku && state.products.length) {
        state.filters.sku = state.products[0].SKU;
      }
      updateSkuOptions();
      renderAll();
    }

    function buildLaneMap(lanes) {
      const map = new Map();
      lanes.forEach(lane => {
        if (!lane.FromCountry || !lane.ToCountry) return;
        const key = `${lane.FromCountry}|${lane.ToCountry}`;
        if (!map.has(key)) {
          map.set(key, lane);
        } else {
          const existing = map.get(key);
          if ((lane.Cost_per_kg_CHF || 0) < (existing.Cost_per_kg_CHF || 0)) {
            map.set(key, lane);
          }
        }
      });
      return map;
    }

    function buildScenarioTariffs(tariffs, scenarioDate) {
      const map = new Map();
      tariffs.forEach(row => {
        if (scenarioDate && row.ScenarioDate !== scenarioDate) return;
        const key = `${row.ComponentClass}|${row.OriginCountry}`;
        map.set(key, row.US_AdValoremTariff_pct || 0);
      });
      return map;
    }

    function resolveTariffRate(componentClass, originCountry, scenarioTariffs) {
      const key = `${componentClass}|${originCountry}`;
      if (state.tariffOverrides.has(key)) {
        return state.tariffOverrides.get(key);
      }
      const inputRow = state.tariffInputs.find(row => row.ComponentClass === componentClass && row.OriginCountry === originCountry);
      if (inputRow && inputRow.UserRate_pct !== null && inputRow.UserRate_pct !== undefined) {
        return Number(inputRow.UserRate_pct) || 0;
      }
      if (scenarioTariffs && scenarioTariffs.has(key)) {
        return scenarioTariffs.get(key) || 0;
      }
      if (inputRow && inputRow.DefaultRate_pct !== null && inputRow.DefaultRate_pct !== undefined) {
        return Number(inputRow.DefaultRate_pct) || 0;
      }
      return 0;
    }

    function updateSkuOptions() {
      const select = document.getElementById('skuSelect');
      const previous = select.value;
      select.innerHTML = state.products.map(p => `<option value="${p.SKU}">${p.SKU} — ${p.Description}</option>`).join('');
      if (state.filters.sku) {
        select.value = state.filters.sku;
      } else if (previous) {
        select.value = previous;
        state.filters.sku = previous;
      }
      const total = state.results.length;
      const filtered = state.results.filter(row => row.SKU === state.filters.sku).length;
      document.getElementById('rowCounter').textContent = `${filtered} / ${total} rows shown`;
    }

    function renderAll() {
      renderKPIs();
      renderLegend();
      renderChart();
      renderTable();
      renderMap();
      renderWhatIf();
      renderInsights();
    }

    function renderKPIs() {
      const container = document.getElementById('kpiRow');
      container.innerHTML = '';
      const rows = state.results.filter(row => row.SKU === state.filters.sku && row.AssemblySiteID === state.filters.assemblySite);
      if (!rows.length) {
        container.innerHTML = '<div class="warning">No data for the selected SKU and assembly site.</div>';
        return;
      }
      const row = rows[0];
      const kpis = [
        {label: 'Landed Cost', value: formatCHF(row.LandedCost_CHF)},
        {label: 'Margin', value: formatCHF(row.Margin_CHF)},
        {label: 'Margin %', value: `${row.MarginPct.toFixed(1)}%`}
      ];
      kpis.forEach(kpi => {
        const card = document.createElement('div');
        card.className = 'kpi-card';
        card.innerHTML = `<h3>${kpi.label}</h3><div class="value">${kpi.value}</div>`;
        container.appendChild(card);
      });
    }

    function renderLegend() {
      const legend = document.getElementById('legend');
      legend.innerHTML = Object.entries(COLORS)
        .map(([site, color]) => `<span><i style="background:${color}"></i>${site}</span>`)
        .join('');
    }

    function renderChart() {
      const skuRows = state.summaryBySku.get(state.filters.sku) || [];
      if (!skuRows.length) {
        Plotly.react('costChart', []);
        return;
      }
      const components = ['Material_CHF','Logistics_CHF','Tariffs_CHF','Conversion_CHF'];
      const traces = components.map((component, index) => {
        return {
          type: 'bar',
          orientation: 'h',
          name: component.replace('_CHF','').replace('_',' '),
          y: skuRows.map(row => row.AssemblySiteID),
          x: skuRows.map(row => row[component]),
          marker: {color: skuRows.map(row => COLORS[row.AssemblySiteID] || '#888'), opacity: 0.8},
          hovertemplate: `${component}: CHF %{x:,.2f}<extra>%{y}</extra>`
        };
      });
      const layout = {
        barmode: 'stack',
        margin: {l: 140, r: 20, t: 10, b: 40},
        xaxis: {title: 'CHF', tickprefix: 'CHF '},
        yaxis: {title: ''},
        legend: {orientation: 'h'}
      };
      Plotly.react('costChart', traces, layout, {responsive: true});
    }

    function renderTable() {
      const tableData = state.results.map(row => ({
        ...row,
        Material_CHF_fmt: formatCHF(row.Material_CHF),
        Logistics_CHF_fmt: formatCHF(row.Logistics_CHF),
        Tariffs_CHF_fmt: formatCHF(row.Tariffs_CHF),
        Conversion_CHF_fmt: formatCHF(row.Conversion_CHF),
        LandedCost_CHF_fmt: formatCHF(row.LandedCost_CHF),
        ListPrice_CHF_fmt: formatCHF(row.ListPrice_CHF),
        Margin_CHF_fmt: formatCHF(row.Margin_CHF),
        MarginPct_fmt: `${row.MarginPct.toFixed(1)}%`
      }));
      if (!state.tableInstance) {
        state.tableInstance = new Tabulator('#table', {
          data: tableData,
          layout: 'fitColumns',
          pagination: 'local',
          paginationSize: 8,
          columnDefaults: {hozAlign: 'right'},
          columns: [
            {title: 'SKU', field: 'SKU', hozAlign: 'left'},
            {title: 'Assembly Site', field: 'AssemblySiteID', hozAlign: 'left'},
            {title: 'Material (CHF)', field: 'Material_CHF_fmt'},
            {title: 'Logistics (CHF)', field: 'Logistics_CHF_fmt'},
            {title: 'Tariffs (CHF)', field: 'Tariffs_CHF_fmt'},
            {title: 'Conversion (CHF)', field: 'Conversion_CHF_fmt'},
            {title: 'Landed Cost (CHF)', field: 'LandedCost_CHF_fmt'},
            {title: 'List Price (CHF)', field: 'ListPrice_CHF_fmt'},
            {title: 'Margin (CHF)', field: 'Margin_CHF_fmt'},
            {title: 'Margin %', field: 'MarginPct_fmt'},
            {title: 'Lead Time (days)', field: 'LeadTime_days', formatter: cell => (cell.getValue() || 0).toFixed(1)}
          ]
        });
      } else {
        state.tableInstance.replaceData(tableData);
      }
      if (state.tableInstance) {
        state.tableInstance.setFilter((data) => data.SKU === state.filters.sku);
      }
    }

    function renderMap() {
      const skuRows = state.summaryBySku.get(state.filters.sku) || [];
      if (!skuRows.length) {
        Plotly.react('mapChart', []);
        return;
      }
      const points = [];
      const lines = [];
      const seenNodes = new Set();
      const sitesById = Object.fromEntries(state.sites.map(s => [s.SiteID, s]));
      const usNode = {SiteID: 'US_PORT', Country: 'United States', City: 'USA', Lat: 37.0902, Lon: -95.7129, Role: 'Import'};

      skuRows.forEach(row => {
        row.ComponentDetails.forEach(detail => {
          const originSite = state.sites.find(site => site.Country === detail.originCountry) || null;
          const assemblySite = sitesById[row.AssemblySiteID];
          if (!assemblySite) return;
          const originPoint = originSite || state.mapNodes.find(node => node.Country === detail.originCountry) || null;
          if (originPoint) {
            const nodeKey = `${originPoint.Country}`;
            if (!seenNodes.has(nodeKey)) {
              points.push({
                lat: originPoint.Lat,
                lon: originPoint.Lon,
                text: `${originPoint.City || originPoint.Country} (${originPoint.Country})`,
                role: 'Origin'
              });
              seenNodes.add(nodeKey);
            }
            const share = row.LandedCost_CHF ? ((detail.cost + detail.logistics) / row.LandedCost_CHF) : 0;
            lines.push({
              lon: [originPoint.Lon, assemblySite.Lon],
              lat: [originPoint.Lat, assemblySite.Lat],
              text: `Component ${detail.component.PartID}<br>Tariff ${detail.tariffRate.toFixed(1)}%` ,
              width: Math.max(1, share * 20),
              color: COLORS[row.AssemblySiteID] || '#999'
            });
          }
        });
        const assemblySite = sitesById[row.AssemblySiteID];
        if (assemblySite) {
          const key = assemblySite.SiteID;
          if (!seenNodes.has(key)) {
            points.push({lat: assemblySite.Lat, lon: assemblySite.Lon, text: `${assemblySite.SiteID} (${assemblySite.Country})`, role: 'Assembly'});
            seenNodes.add(key);
          }
          if (assemblySite.Country !== 'United States') {
            lines.push({
              lon: [assemblySite.Lon, usNode.Lon],
              lat: [assemblySite.Lat, usNode.Lat],
              text: `Final shipment\nTariff ${row.FinalTariffRate.toFixed(1)}%`,
              width: 2.5,
              color: '#555'
            });
          }
        }
      });

      if (!seenNodes.has('US_PORT')) {
        points.push({lat: usNode.Lat, lon: usNode.Lon, text: 'United States (Import)', role: 'Import'});
      }

      const pointTrace = {
        type: 'scattergeo',
        mode: 'markers+text',
        text: points.map(p => p.text),
        lon: points.map(p => p.lon),
        lat: points.map(p => p.lat),
        marker: {size: 8, color: points.map(p => p.role === 'Assembly' ? '#222' : '#888')},
        textposition: 'top center'
      };
      const lineTraces = lines.map(line => ({
        type: 'scattergeo',
        mode: 'lines',
        lon: line.lon,
        lat: line.lat,
        line: {width: line.width, color: line.color},
        hoverinfo: 'text',
        text: line.text
      }));
      const layout = {
        geo: {
          scope: 'world',
          projection: {type: 'natural earth'},
          showland: true,
          landcolor: '#f6f1ea'
        },
        margin: {l: 0, r: 0, t: 0, b: 0}
      };
      Plotly.react('mapChart', [pointTrace, ...lineTraces], layout, {responsive: true});
    }

    function renderWhatIf() {
      const rows = state.summaryBySku.get(state.filters.sku) || [];
      if (!rows.length) {
        Plotly.react('whatIfChart', []);
        return;
      }
      const trace = {
        type: 'scatter',
        mode: 'markers+text',
        x: rows.map(row => row.LeadTime_days),
        y: rows.map(row => row.MarginPct),
        text: rows.map(row => row.AssemblySiteID),
        marker: {size: 12, color: rows.map(row => COLORS[row.AssemblySiteID] || '#999')},
        hovertemplate: 'Lead time: %{x:.1f} days<br>Margin: %{y:.1f}%<extra>%{text}</extra>'
      };
      const layout = {
        xaxis: {title: 'Lead time (days)'},
        yaxis: {title: 'Margin %'},
        margin: {l: 50, r: 10, t: 10, b: 40}
      };
      Plotly.react('whatIfChart', [trace], layout, {responsive: true});
    }

    function renderInsights() {
      const rows = state.summaryBySku.get(state.filters.sku) || [];
      if (!rows.length) {
        document.getElementById('insightsText').textContent = 'Upload the workbook to begin.';
        return;
      }
      const selected = rows.find(row => row.AssemblySiteID === state.filters.assemblySite) || rows[0];
      let comparison = '';
      rows.forEach(row => {
        if (row.AssemblySiteID === selected.AssemblySiteID) return;
        const delta = row.MarginPct - selected.MarginPct;
        const symbol = delta >= 0 ? '+' : '';
        comparison += `<li>${row.AssemblySiteID} vs ${selected.AssemblySiteID}: ${symbol}${delta.toFixed(1)} pts Margin</li>`;
      });
      document.getElementById('insightsText').innerHTML = `Currently highlighting <strong>${selected.AssemblySiteID}</strong> for <strong>${selected.SKU}</strong>.` +
        (comparison ? `<ul>${comparison}</ul>` : '<p>No alternative assembly sites available.</p>');
    }

    function renderFxList() {
      const list = document.getElementById('fxList');
      if (!state.fx.length) {
        list.innerHTML = '<li>No FX data</li>';
        return;
      }
      list.innerHTML = state.fx
        .map(row => `<li>${row.Currency}: ${row.USD_per_unit ?? 'n/a'}</li>`)
        .join('');
    }

    function formatCHF(value) {
      if (value === null || value === undefined || Number.isNaN(value)) return 'CHF 0.00';
      return 'CHF ' + Number(value).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }
  </script>
</body>
</html>
